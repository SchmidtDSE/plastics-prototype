# Determine delta
var totalConsumption = (
  out.{{ region }}.consumptionAgricultureMT +
  out.{{ region }}.consumptionConstructionMT +
  out.{{ region }}.consumptionElectronicMT +
  out.{{ region }}.consumptionHouseholdLeisureSportsMT +
  out.{{ region }}.consumptionPackagingMT +
  out.{{ region }}.consumptionTransportationMT +
  out.{{ region }}.consumptionTextileMT +
  out.{{ region }}.consumptionOtherMT
);
var delta = in.{{ region }}PreDeltaGoodsImportPercent / 100 * totalConsumption;

# Propogate into domestic consumption
distribute delta across [
  out.{{ region }}.consumptionAgricultureMT,
  out.{{ region }}.consumptionConstructionMT,
  out.{{ region }}.consumptionElectronicMT,
  out.{{ region }}.consumptionHouseholdLeisureSportsMT,
  out.{{ region }}.consumptionPackagingMT,
  out.{{ region }}.consumptionTransportationMT,
  out.{{ region }}.consumptionTextileMT,
  out.{{ region }}.consumptionOtherMT
] proportionally;

# Propogate into domestic waste assuming error present throughout series
distribute delta across [
  newRecyclingPercent,
  newLandfillPercent,
  newIncinerationPercent,
  newMismanagedPercent
] proportionally;

# Determine trade impact
var changeImports = delta;
limit changeImports to [0,];

var changeExports = -1 * delta;
limit changeExports to [0,];

# Report trade impact
var newNet = out.{{ region }}.netImportsMT - out.{{ region }}.netExportsMT + delta;
var newImports = newNet;
var newExports = newNet * -1;

limit newImports = [0,];
limit newExports = [0,];

out.{{ region }}.netImportsMT = newImports;
out.{{ region }}.netExportsMT = newExports;

# Balance goods imports
var offsetPartnerExports = -1 * changeImports;
distribute offsetPartnerExports across [
  {{#each otherRegions}}
  out.{{ this }}.netExportsMT{{#unless @last}},{{/unless}}
  {{/each}}
] proportionally;

# Propogate into trade partners production
distribute changeImports across [
  {{#each otherRegions}}
  out.{{ region }}.primaryProductionMT by out.{{ this }}.netImportsMT * out.{{ region }}.primaryProductionMT,
  out.{{ region }}.secondaryProductionMT by out.{{ this }}.netImportsMT * out.{{ region }}.secondaryProductionMT{{#unless @last}},{{/unless}}
  {{/each}}
] propotionally;

# Balance goods exports
var offsetPartnerImports = -1 * changeExports;
distribute offsetPartnerImports across [
  {{#each otherRegions}}
  out.{{ this }}.netImportsMT{{#unless @last}},{{/unless}}
  {{/each}}
] proportionally;

# Propogate into trade partners waste fate
{{#each otherRegions}}
var {{ this }}WasteMultiplier = out.{{ this }}.netImportsMT;
{{ this }}WasteMultiplier = {{ this }}Multiplier - out.{{ this }}.netWasteExportMT;
{{ this }}WasteMultiplier = {{ this }}Multiplier + out.{{ this }}.netWasteImportMT;
{{/each}}

distribute offsetPartnerImports across [
  {{#each otherRegions}}
  out.{{ this }}.eolRecyclingMT by out.{{ this }}.eolRecyclingMT * {{ this }}WasteMultiplier,
  out.{{ this }}.eolLandfillMT by out.{{ this }}.eolLandfillMT * {{ this }}WasteMultiplier,
  out.{{ this }}.eolIncinerationMT by out.{{ this }}.eolIncinerationMT * {{ this }}WasteMultiplier,
  out.{{ this }}.eolMismanagedMT by out.{{ this }}.eolMismanagedMT * {{ this }}WasteMultiplier{{#unless @last}},{{/unless}}
  {{/each}}
] proportionally;
